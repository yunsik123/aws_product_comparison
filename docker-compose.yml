version: '3.8'

services:
  backend:
    build:
      context: ./backend
      dockerfile: ../infra/docker/Dockerfile.backend
    container_name: nongshim-backend
    ports:
      - "8000:8000"
    environment:
      - ELEVENST_API_KEY=${ELEVENST_API_KEY:-}
      - DANAWA_API_KEY=${DANAWA_API_KEY:-}
      - SERPAPI_API_KEY=${SERPAPI_API_KEY:-}
      - AWS_REGION=${AWS_REGION:-ap-northeast-2}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-}
      - BEDROCK_MODEL_ID=${BEDROCK_MODEL_ID:-amazon.titan-text-express-v1}
      - CACHE_TTL_SECONDS=${CACHE_TTL_SECONDS:-900}
      - RATE_LIMIT_SECONDS=${RATE_LIMIT_SECONDS:-60}
      - ENABLE_SCRAPING=${ENABLE_SCRAPING:-false}
    volumes:
      - cache_data:/app/cache
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3

  streamlit:
    build:
      context: ./streamlit_app
      dockerfile: ../infra/docker/Dockerfile.streamlit
    container_name: nongshim-streamlit
    ports:
      - "8501:8501"
    environment:
      - BACKEND_URL=http://backend:8000
    depends_on:
      - backend
    restart: unless-stopped

volumes:
  cache_data:


networks:
  default:
    name: nongshim-network
